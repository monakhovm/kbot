name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
    ci:
        name: CI
        runs-on: ubuntu-latest
    
        steps:
        - name: Checkout code
          uses: actions/checkout@v3
          with:
            fetch-depth: 0
    
        - name: Run tests
          run: make test
    
        - name: Log in to Docker Hub
          uses: docker/login-action@v1
          with:
            username: ${{ secrets.DOCKER_USERNAME }}
            password: ${{ secrets.DOCKER_PASSWORD }}
    
        - name: Build and push Docker image
          env:
            APP: "kbot"
            REGISTRY: ghcr.io/${{ secrets.DOCKER_USERNAME }}
          run: make image push

    cd:
        name: CD
        runs-on: ubuntu-latest

        needs: ci
    
        steps:
        - name: Checkout code
          uses: actions/checkout@v3
          with:
            fetch-depth: 0
        - run: echo "VERSION=$(git describe --tags --abbrev=0)-$(git rev-parse --short HEAD)" >> $GITHUB_ENV

        - uses: mikefarah/yq@master
          with:
            cmd: yq -i '.image.tag = strenv(VERSION)' helm/values.yaml

        - run: |
            git config user.email "github-actions@github.com"
            git config user.name "GitHub Actions"
            git commit -am "Update image tag to ${VERSION}"
            git push