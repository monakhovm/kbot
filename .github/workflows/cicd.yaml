name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
    ci:
        name: CI
        runs-on: ubuntu-latest
    
        steps:
        - name: Checkout code
          uses: actions/checkout@v3
          with:
            fetch-depth: 0
    
        - name: Run tests
          run: make test
    
        - name: Log in to Docker Hub
          uses: docker/login-action@v1
          with:
            registry: ghcr.io
            username: ${{ github.actor }}
            password: ${{ secrets.GH_TOKEN }}
    
        - name: Build and push Docker image
          env:
            APP: "kbot"
            REGISTRY: ghcr.io/${{ github.actor }}
          run: make image push

    cd:
        name: CD
        runs-on: ubuntu-latest

        needs: ci
    
        steps:
        - name: Checkout code
          uses: actions/checkout@v3

        - run: |
            echo "VERSION=$(git describe --tags --abbrev=0)-$(git rev-parse --short HEAD)" >> $GITHUB_ENV

        - uses: mikefarah/yq@master
          with:
            cmd: | 
              yq -i '.image.tag = ${VERSION}' helm/values.yaml

        - name: Log in to Docker Hub
          uses: docker/login-action@v1
          with:
            registry: ghcr.io
            username: ${{ github.actor }}
            password: ${{ secrets.GH_TOKEN }}
    
        - name: Package and Push Helm chart
          env:
            APP: "kbot"
            REGISTRY: ghcr.io/${{ github.actor }}
            VERSION: ${{ env.VERSION }}
          run: make helmchart

        - run: |
            git config user.email github-actions@github.com
            git config user.name github-actions
            git remote set-url origin https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }}.git
            git commit -am "Update image tag to ${VERSION}"
            git push